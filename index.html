<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Further Adventures of the Event Loop</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/loops.css">

		<style>
      .task1, .task2 {
        background-size: 400% 400%;
        background-image: radial-gradient(circle at left, var(--background-colour), transparent 50%, transparent);
        background-position: bottom right;
        transition: background-position 1s, color 1s;
      }
			.highlighted .task1, .highlighted .task2 {
        background-position: top left;
      }
      .highlighted .task2 {
        color: fuchsia;
      }
      .task1 {
        --background-colour: #444;
      }
			.task2 {
				--background-colour: rgb(170, 230, 238);
      }
			.task2 .hljs-string {
				color: #444;
			}
		</style>
		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<div class="mask">
						<svg class="title" viewBox="0 0 100 50" style="width: 80%">
							<path id="curve" d="M 10 50 a 40 40 0 0 1 80 0" fill="transparent" />
							<text font-family="cursive">
								<textPath font-size=".5em" textLength="125" xlink:href="#curve">
									Further Adventures of
								</textPath>
							</text>
						</svg>
					</div>
					<h1>The Event Loop</h1>
					<div class="twitter">@erinjzimmer</div>
				</section>
				<section>
					<h2>What even is the Event Loop?</h2>
					<div class="notes">
						To understand what the event loop is, first it might be helpful to understand what it is not.
					</div>
				</section>
				<section class="full-height">
					<fieldset class="browser-internals">
						<legend>The Browser</legend>
						<div class="browser-bits">
							<img id="engine" src="css/JavaScript-logo.png" class="fragment" style="margin-left: 0" />
							<task-source type="network" class="fragment"></task-source>
							<task-source type="timer" class="fragment"></task-source>
							<task-source type="drive" class="fragment"></task-source>
							<img src="css/mouse-pointer.svg" class="fragment" style="margin: .75em" />
							<div class="html fragment"></div>
							<div id="web-apis" style="animation: unset">Web APIs</div>
						</div>
					</fieldset>
					<div class="notes">
						- You see, browsers have a bunch of different bits in them
						- One is the bit that runs from JavaScript
						- But there's also another bit that takes care of network requests
						- And a bit that looks after timers
						- A bit that can do disk I/O
						- A bit that listens for user interactions
						- And a heap of bits that interact with the DOM and CSS.
						- Collectively, these bits that aren't the bit that runs JavaScript are called...
						- ... Web APIs. The event loop isn't a web API.
					</div>
					<script>
						document.querySelector('.browser-internals').addEventListener('click', function () {
							this.classList.add('web-apis');
							this.addEventListener('click', () => {
								document.querySelector('#web-apis').style.opacity = 1;
							}, { once: true });
						}, { once: true });
					</script>
				</section>
				<section>
					<span style="position: relative">
						<img src="css/libuv.svg" style="width: calc(80vmin - 80px)" />
						<div class="libuv">libuv</div>
					</span>
					<div class="notes">
						Node equivalent == unicorn velocity library.
						Because of course it is.
						The event loop also isn't libuv.
					</div>
				</section>
				<section>
					<fieldset class="browser-internals engine">
						<legend>The Browser</legend>
						<div class="browser-bits">
							<img id="engine" src="css/JavaScript-logo.png" style="margin-left: 0" />
							<task-source type="network"></task-source>
							<task-source type="timer"></task-source>
							<task-source type="drive"></task-source>
							<img src="css/mouse-pointer.svg" style="margin: .75em" />
							<div class="html"></div>
							<div id="engines" style="animation: unset">JavaScript Engine</div>
						</div>
					</fieldset>
					<script>
						document.querySelector('.browser-internals.engine').addEventListener('click', function () {
							this.querySelector('#engine').classList.add('highlighted');
							this.addEventListener('click', () => {
								document.getElementById('engines').style.opacity = 1;
							})
						}, { once: true });
					</script>
					<div class="notes">
						The bit that is the bit that runs JavaScript is called the JavaScript engine.
					</div>
				</section>
				<section>
					<div class="engine-logos">
						<img class="fragment" src="css/v8-logo.png" />
						<img class="fragment" src="css/edge-logo.png" style="transform: scale(.6)" />
						<img class="fragment" src="css/squirrelfish.png" />
					</div>
					<img class="fragment" src="css/spider-monkey.jpg" style="width: 80%" />
					<div class="notes">
						There are a bunch of different JS engines kicking around
						- V8, in Chrome and Node
						- Chakra which powers Edge
						- er, Safari's SquirrelFish
						- and SpiderMonkey from Mozilla, which I couldn't find a logo for,
						so here's a picture of an actual SpiderMonkey
						spider monkey photo from Ewa https://www.flickr.com/photos/ewas-world/
						The event loop lives in JavaScript engines.
					</div>
				</section>
				<section>
					<pre><code data-noescape class="js" style="font-size: 4em">
while (true) {
 <span class="variable-name">task</span> = taskQueue.pop();
 execute(<span class="variable-name">task</span>);
}
					</code></pre>
					<div class="notes">
						The main function of the JS engine
						In its simplest form, would look something like this
						Now, while I'm sure we all understand how the loop part works, I think
						this code snippet probably raises a couple of other questions, like...
					</div>
				</section>
				<section>
					<ul>
						<li class="fragment">What's a task?</li>
						<li class="fragment">What's a task queue?</li>
						<li class="fragment">How does one execute a task?</li>
					</ul>
					<img src="quizzical-raptor" />	
				</section>
				<section>
					<div class="text">What's a <code style="font-size: 1.5em" class="variable-name">task</code>?</div>
					And where do they come from?
				</section>
				<section>
					A task is basically any bit of JavaScript that's going to get executed.
					Example of script tag -> task -> task queue
					Another example with callback that's going to be in two tasks
				</section>
				<section>
					To understand why JS uses tasks (and task queues), we should have a quick look at something everyone 
					knows about JS and how that relates to the bits of the browser (or Node) that aren't the JS engine
				</section>
				<section>
					<div>JavaScript is single-threaded</div>
					<div class="notes">
						So this is a thing that most people know about JS, or at least have heard.
						An example of some code that looks like it could be broken by multithreading, but can't
						We know if we start running this code, all of it is going to run without anything else 
						happening part way through
					</div>
				</section>
				<section>
					<div>Browsers have as many threads as they like</div>
					<div class="notes">
						Browser window might have threads for 
						 - keeping track of mouse and keyboard events
						 - making network requests
						 - handling timers
						 - disk operations
						 Chrome has a separate thread (actually a whole separate process) for the browser
						 chrome and each of the tabs, which is why your task manager ends up full of Chrome
					</div>
				</section>
				<section>
					All of the asynchronous tasks that you kick off from your JS run in a different thread
					than your author code.
					xhr request -> new thread for network request -> request completes, callback 
					is ready to run
					BUT the rest of your code is still running and the new callback can't interrupt it
					So it gets added to a queue to wait until its turn
					Do an interactive example with async tasks being added to queues
				</section>
				<section>
					And this is where the event loop comes in.
					Remember our code from before?
					The event loop is responsible for picking tasks off the task queue and executing them
				</section>
				<section data-background-image="css/glastonbury.jpg">
					<div class="glastonbury">
						<a class="heading" href="just-task-queue.html">What is a task queue and what's it for?</a>
					</div>
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 4em">
while (true) {
 <span class="variable-name">task</span> = taskQueue.pop();
 execute(<span class="variable-name">task</span>);
}
					</code></pre>
					<div class="notes">
						The thing is, it's a little more complicated than that
					</div>
				</section>
				<section data-background-image="css/mario.jpg">
					<a class="heading" href="simple.html">The Rendering Pipeline</a>
				</section>
				<section>
					<div style="display: flex; justify-content: space-between">
						<img class="border" src="css/unco-cat.gif" />\
						<div class="notes">
							Long running tasks will cause your browser to start dropping frames
							and, much like this cat, your app just won't run right
						</div>
					</div>
        </section>
        <section>
          <pre><code style="font-size: 4em;">
						make this into a realistic example
function veryLongTask() {
  firstPartOfTask();
  setTimeout(restOfTheTask);
}
          </code></pre>
				</section>
				<section>
					Or you could use a webworker, seeing as that's literally what they're 
					Put the code for starting a web worker
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 3.7em">
while (true) {
 <span class="variable-name">task</span> = taskQueue.pop();
 execute(<span class="variable-name">task</span>);

 if (isRepaintTime()) repaint();
}
					</code></pre>
				</section>
				<section>
					<div style="font-size: 2.5em">An <u>event loop</u> has one or more <b>task queues.</b></div>
				</section>
				<section>
						<pre><code>
bool did_work = delegate->DoWork();
if (!keep_running_)
	break;
did_work |= delegate->DoDelayedWork(&delayed_work_time_);
if (!keep_running_)
	break;
if (did_work)
	continue;
did_work = delegate->DoIdleWork();
if (!keep_running_)
	break;
					</code></pre>
				</section>
				<section>
					<a style="font-size: 2.5em;" href="multiple-queues.html">Theoretical browser with multiple task queues</a>
				</section>
				<section>
					<div class="list-container" style="font-size: 1.5em">
						<ul>
							<li class="fragment">Queues can be executed in any order</li>
							<li class="fragment">Tasks in the same queue must be executed in the order they arrived</li>
							<li class="fragment">Tasks from the same source<br> must go in the same queue</li>
						</ul>
					</div>
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 3.7em">
while (true) {
 <span class="variable-name">queue</span> = getNextQueue();
 <span class="variable-name">task</span> = <span class="variable-name">queue</span>.pop();
 execute(<span class="variable-name">task</span>);

 if (isRepaintTime()) repaint();
}
					</code></pre>
				</section>
				<section data-background-image="css/tiny-horse.jpg">
					make this little foot and his mum
					<a class="headings microtasks" href="microtasks.html">Microtasks</a>
					<div style="font-size: 1em; color: white; background: rgba(206, 190, 190, 0.3); padding: .5em;" 
					class="demo-link">Image by <a href="https://www.flickr.com/people/9197427@N06">Pete Markham</a></div>
				</section>
				<section class="text">
					<a href="infinite-timeouts.html">Tasks</a>
					<div style="margin: 10px">vs</div>
					<a href="infinite-promises.html" target="_blank" rel="noopener">Microtasks</a>	
				</section>
				<section>
					do the live demo again showing the promises blocking
				</section>
				<section>
					<pre><code data-noescape class="js" style="font-size: 3.5em">
while (true) {
 <span class="variable-name">queue</span> = getNextQueue();
 <span class="variable-name">task</span> = <span class="variable-name">queue</span>.pop();
 execute(<span class="variable-name">task</span>);

 while (<span class="variable-name">microtaskQueue</span>.hasTasks())
  doMicrotask();

 if (isRepaintTime()) repaint();
}
					</code></pre>
				</section>
				<section data-background-image="css/gallop.jpg">
					<h2 class="gallop">Animation Frame Callback Queue</h2>
				</section>
				<section>
					<pre><code style="text-align: center; font-size: 3.7em;">
requestAnimationFrame(callback);
					</code></pre>
				</section>
				<section>
					make a dinosaur themed animation demo
					show what happens with no requestAnimationFrame
					both frames end up in the same render phase, so the animation doesn't work
					we need a way to ensure the first line executes, then the screen repaints,
					then the second line executes
					show demo
					so if we change our code to use requestAnimationFrame like so 
					(remember we need two calls to requestAnimationFrame, else both lines 
					could still end up in the same loop)
					now it works!
				</section>
				<section>
					<pre><code class="javascript" style="font-size: 3em">
requestAnimationFrame(() => {
  this.browser.classList.remove('slide');

  requestAnimationFrame(() => {
    this.browser.classList.add('slide');
  });
});				
					</code></pre>
				</section>
				<section>
					<pre><code class="javascript" style="font-size: 3em">
this.browser.classList.remove('slide');
this.browser.classList.add('slide');					
					</code></pre>
					<img style="filter: drop-shadow(2px 2px 1px var(--background-start));" src="css/Clippy.png" />
					<a class="demo-link" style="left: 0; right: unset" href="requestAnimationFrame.html">Demo</a>
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 2.6em">
while (true) {
 <span class="variable-name">queue</span> = getNextQueue();
 <span class="variable-name">task</span> = <span class="variable-name">queue</span>.pop();
 execute(<span class="variable-name">task</span>);

 while (<span class="variable-name">microtaskQueue</span>.hasTasks()) 
  doMicrotask();

 if (isRepaintTime()) {
  <span class="variable-name">animationTasks</span> = <span class="variable-name">animationQueue</span>.copyTasks();
  for (<span class="variable-name">task</span> in <span class="variable-name">animationTasks</span>) 
   doAnimationTask(<span class="variable-name">task</span>);
		
  repaint();
 }
}
					</code></pre>
				</section>
				<section>
					<div class="text">... but what about Node?</div>
				</section>
				<section>
					<img class="border full-page" src="css/good-news-everyone.jpg" />
				</section>
				<section>
					<div class="list-container" style="font-size: 2em;">
						<ul>
							<li class="fragment">No script parsing events</li>
							<li class="fragment">No pesky user interactions</li>
							<li class="fragment">No animation frame callbacks</li>
							<li class="fragment">No rendering pipeline <i>at all</i></li>
						</ul>
					</div>
				</section>
				<section>
					<img class="full-page" src="css/corgi-carousel.gif" />
				</section>
				<section>
					<img class="full-page" src="css/thunderbolt.gif" />
				</section>
				<section>
					<a class="text" href="node.html">Node event loop demo</a>
				</section>
				<section>
					<pre><code style="text-align: center; font-size: 4em" class="lisp">setImmediate(callback)</code></pre>
				</section>
				<section>
					<div style="display: flex; align-items: center; font-size: 2em">
						<pre><code>setTimeout(callback, 0)</code></pre>
						<img style="width: 20vmin" src="css/hedgehog.png" />
					</div>
					<div style="display: flex; align-items: center; font-size: 2em">
						<img style="width: 20vmin" src="css/sonic.png" />
						<pre><code>setImmediate(callback)</code></pre>
					</div>
					<a class="demo-link" href="node.html">Demo</a>
				</section>
				<section>
					<pre><code style="text-align: center; font-size: 4em" class="lisp">process.nextTick(callback)</code></pre>
					<a class="demo-link" href="node.html">Demo</a>
				</section>
				<section>
					<div style="display: flex">
						<pre><code style="font-size: 3em">setImmediate():</code></pre>
						<div style="padding: .5em; font-size: 2.2em; align-self: center">do something on the next tick</div>
					</div>
					<div style="display: flex;" class="fragment">
						<pre><code style="font-size: 3em">process.nextTick():</code></pre>
						<div style="padding: .5em; font-size: 2.2em; align-self: center">do something immediately</div>
					</div>
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 2.6em">
while (tasksAreWaiting()) {
 <span class="variable-name">queue</span> = getNextQueue();

 while (queue.hasTasks()) {
  <span class="variable-name">task</span> = <span class="variable-name">queue</span>.pop();
  execute(<span class="variable-name">task</span>);

  while (<span class="variable-name">nextTickQueue</span>.hasTasks()) 
   doNextTickTask();

  while (<span class="variable-name">promiseQueue</span>.hasTasks()) 
   doPromiseTask();
 }
}
					</code></pre>
				</section>
				<section>
					<div style="position: absolute; top: 50vh; font-size: 3em;">Web workers</div>
					<img src="css/redback.png" />
				</section>
				<section>
						<div style="width: 45%; position: fixed; top: 5vh; left: 0; border: 4px solid red; padding: 5px">
							<div style="display: flex; flex-wrap: wrap; justify-content: space-between; margin: auto;">
								<div class="area" style="width: 40%; display: flex; flex-direction: column; justify-content: flex-end">
									<div style="flex-grow: 1">stack</div>
									<div class="task">setTimeout(cb)</div>
									<div class="task">main()</div>
								</div>
								<div class="area" style="width: 55%;">
									<div>webapis</div>
								</div>
								<div class="area" style="display: flex; width: 100%; margin-top: 1vw; height: 4em;">
									<div style="margin: auto 0;">task queue</div>
									<div class="task" style="margin-left: 5px">cb</div>
								</div>
							</div>
						</div>
						<div class="loading-dots" style="position: fixed; top: 30%; left: 45%; right: 25%;"></div>
						<div style="width: 25%; position: fixed; right: 0; top: 30%; border: 2px solid white; padding: 5px;">
							<div style="display: flex; flex-wrap: wrap; justify-content: space-between;">
								<div class="area" style="width: 40%; display: flex; flex-direction: column; justify-content: flex-end">
									<div style="flex-grow: 1">stack</div>
									<div class="task"></div>
									<div class="task"></div>
									<div class="task"></div>
								</div>
								<div class="area" style="width: 55%;">
									<div>webapis</div>
								</div>
								<div class="area" style="display: flex; width: 100%; margin-top: 1vw; height: 4em;">
									<div style="margin: auto 0;">task queue</div>
									<div class="task" style="margin-left: 5px">cb</div>
								</div>
							</div>
						</div>
						<div class="loading-dots" 
								style="position: fixed; top: 7em; left: 40%; transform: rotate(.25turn); transform-origin: left;">
						</div>
						<div style="width: 25%; position: fixed; left: 25%; bottom: 5vh; border: 2px solid white; padding: 5px;">
							<div style="display: flex; flex-wrap: wrap; justify-content: space-between;">
								<div class="area" style="width: 40%; display: flex; flex-direction: column; justify-content: flex-end">
									<div style="flex-grow: 1">stack</div>
									<div class="task"></div>
									<div class="task"></div>
									<div class="task"></div>
								</div>
								<div class="area" style="width: 55%;">
									<div>webapis</div>
								</div>
								<div class="area" style="display: flex; width: 100%; margin-top: 1vw; height: 4em;">
									<div style="margin: auto 0;">task queue</div>
									<div class="task" style="margin-left: 5px">cb</div>
								</div>
							</div>
						</div>
					</section>								
				</section>
				<section>
					<ul style="font-size: 4em">
						<li class="fragment">No script tags</li>
						<li class="fragment">No user interactions</li>
						<li class="fragment">No DOM manipulation</li>
					</ul>
					<a class="demo-link" href="web-worker.html">Demo</a>
				</section>
				<section>
					<img class="full-page" src="css/thats-it-too-easy.jpg" />
				</section>
				<section>
					<div style="font-size: 3.9em;">Long running tasks will make your web page run like a wonky cat</div>
				</section>
				<section>
					<div style="font-size: 4em">Promises and nextTick tasks can make it run like a dead cat</div>
				</section>
				<section>
					<div style="font-size: 4em">Node is a bit different</div>
				</section>
				<section>
					<div style="font-size: 4em">Web workers do their own thing</div>
				</section>
				<section>
					<div style="font-size: 3.5em;">The event loop is more exciting than you could possibly have imagined</div>
				</section>
				<section data-background-image="css/roller-coaster.jpg">
					<div class="frosted">
						<div style="margin-bottom: .5em">@erinjzimmer</div>
						<a href="/package.json" style="color: currentColor; font-size: .9em">https://ejzimmer.github.io/event-loop-talk</a>
					</div>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>
		
		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				controls: false,
				progress: false,
				history: true,
				transition: 'fade',
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
				]
			});
		</script>

		<link rel="import" href="components/event-loop.html">
		<link rel="import" href="components/browser.html">
		<link rel="import" href="components/queues.html">
		<link rel="import" href="components/rendering-pipeline.html">
		<link rel="import" href="components/queue-selector.html">
		<link rel="import" href="components/queue.html">
    <link rel="import" href="components/task-source.html">
    
    <script>
      // const task = document.querySelector('.tasks');
      // task.addEventListener('click', function () {
      //   this.classList.add('highlighted');
      // });
      // document.body.addEventListener('keydown', (event) => {
      //   console.log(event.key);
      // });
		</script>
	</body>
</html>
